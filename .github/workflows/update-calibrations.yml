name: Update TV Calibration Database

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'scripts/**'
      - '.github/workflows/**'

jobs:
  update-calibrations:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          npm install
          echo "âœ… Dependencies installed"
      
      - name: Scrape RTINGS data
        run: |
          echo "ðŸ” Scraping RTINGS.com for TV calibration data..."
          node scripts/scrape-rtings.js
          echo "âœ… RTINGS data scraped"
        continue-on-error: true
      
      - name: Scrape AVS Forum data
        run: |
          echo "ðŸ” Scraping AVS Forum for community calibrations..."
          node scripts/scrape-avs-forum.js
          echo "âœ… AVS Forum data scraped"
        continue-on-error: true
      
      - name: Generate calibration database
        run: |
          echo "ðŸ“Š Generating unified calibration database..."
          node scripts/generate-database.js
          echo "âœ… Database generated"
      
      - name: Check for changes
        id: check_changes
        run: |
          if [ -n "$(git status --porcelain data/calibrations.json)" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ Changes detected in calibration database"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes detected"
          fi
      
      - name: Commit and push changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config user.name "TV Calibration Bot"
          git config user.email "actions@github.com"
          
          TOTAL_MODELS=$(node -e "const data = require('./data/calibrations.json'); console.log(data.tv_models.length)")
          TOTAL_SETTINGS=$(node -e "const data = require('./data/calibrations.json'); console.log(data.calibration_settings.length)")
          
          git add data/calibrations.json data/rtings-raw.json data/avs-forum-raw.json
          git commit -m "ðŸ¤– Auto-update calibrations: $(date +'%Y-%m-%d %H:%M UTC')

          ðŸ“Š Database Statistics:
          - TV Models: ${TOTAL_MODELS}
          - Calibration Presets: ${TOTAL_SETTINGS}
          - Last Updated: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          Updated by GitHub Actions workflow"
          
          git push
          echo "âœ… Changes committed and pushed"
      
      - name: Generate summary
        if: always()
        run: |
          echo "## ðŸ“º TV Calibration Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "data/calibrations.json" ]; then
            TOTAL_MODELS=$(node -e "const data = require('./data/calibrations.json'); console.log(data.tv_models.length)")
            TOTAL_SETTINGS=$(node -e "const data = require('./data/calibrations.json'); console.log(data.calibration_settings.length)")
            LAST_UPDATE=$(node -e "const data = require('./data/calibrations.json'); console.log(data.last_updated)")
            
            echo "### âœ… Update Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Total TV Models**: ${TOTAL_MODELS}" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Calibration Presets**: ${TOTAL_SETTINGS}" >> $GITHUB_STEP_SUMMARY
            echo "- **Last Updated**: ${LAST_UPDATE}" >> $GITHUB_STEP_SUMMARY
            echo "- **Changes Detected**: ${{ steps.check_changes.outputs.changes }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ Update Failed" >> $GITHUB_STEP_SUMMARY
            echo "Database file was not generated. Check logs above." >> $GITHUB_STEP_SUMMARY
          fi
